name: Validate

on:
  push:
    branches: [main, master, 'feature/**']
  pull_request:
    branches: [main, master]

jobs:
  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck
      
      - name: Lint bash scripts
        run: |
          find home \( -name "*.sh.tmpl" -o -name "*.sh" \) | \
            grep -v "home/dot_claude/tools" | \
            xargs -I {} shellcheck -x {}

  validate-templates:
    name: Validate Chezmoi Templates
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Install chezmoi
        run: sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin
      
      - name: Validate templates
        run: .github/scripts/validate-templates.sh

  check-secrets:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check-links:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify documentation links
        run: .github/scripts/check-links.sh

  check-executability:
    name: Check Script Permissions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify scripts are executable
        run: |
          find home -name "run_once_*.sh.tmpl" | while read -r file; do
            if [ ! -x "$file" ]; then
              echo "âŒ Script not executable: $file"
              exit 1
            fi
          done
          echo "âœ… All scripts have correct permissions"

  # Discord notification for PR validation results
  discord-notify:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [lint, validate-templates, check-secrets, check-links, check-executability]
    if: always()
    steps:
      - name: Send Discord Notification
        uses: actions/github-script@v7
        with:
          script: |
            const webhookUrl = '${{ secrets.DISCORD_WEBHOOK }}';
            const jobs = {
              lint: '${{ needs.lint.result }}',
              templates: '${{ needs.validate-templates.result }}',
              secrets: '${{ needs.check-secrets.result }}',
              links: '${{ needs.check-links.result }}',
              executable: '${{ needs.check-executability.result }}'
            };
            
            const allPassed = Object.values(jobs).every(r => r === 'success');
            const status = allPassed ? 'âœ… PASSED' : 'ðŸ”´ FAILED';
            const color = allPassed ? 3066993 : 15158332;
            const eventType = '${{ github.event_name }}' === 'pull_request' ? 'PR Validation' : 'Push Validation';
            const prNumber = '${{ github.event.pull_request.number }}';
            const prTitle = '${{ github.event.pull_request.title }}';
            
            let description = '**Test Results:**\n';
            description += `â€¢ Shell Lint: ${jobs.lint}\n`;
            description += `â€¢ Templates: ${jobs.templates}\n`;
            description += `â€¢ Secrets Scan: ${jobs.secrets}\n`;
            description += `â€¢ Documentation: ${jobs.links}\n`;
            description += `â€¢ Permissions: ${jobs.executable}\n`;
            
            if (prNumber) {
              description += `\n**PR #${prNumber}:** ${prTitle}`;
            }
            
            const payload = {
              embeds: [{
                title: `${eventType} ${status}`,
                description: description,
                color: color,
                fields: [
                  {
                    name: 'Repository',
                    value: '${{ github.repository }}',
                    inline: true
                  },
                  {
                    name: 'Branch',
                    value: '${{ github.ref_name }}',
                    inline: true
                  },
                  {
                    name: 'Commit',
                    value: '${{ github.sha }}'.substring(0, 7),
                    inline: true
                  },
                  {
                    name: 'Author',
                    value: '${{ github.actor }}',
                    inline: true
                  }
                ],
                timestamp: new Date().toISOString(),
                url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
                footer: {
                  text: 'Dotfiles CI'
                }
              }]
            };
            
            await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
