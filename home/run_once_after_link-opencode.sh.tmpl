#!/bin/bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"

set -e

# {{ $os := .chezmoi.os }}
# {{ $isWsl := .is_wsl }}

echo "Linking opencode to .claude configuration..."

# Source directories (where chezmoi deployed the files)
CLAUDE_DIR="$HOME/.claude"
COMMANDS_SRC="$CLAUDE_DIR/commands"
AGENTS_SRC="$CLAUDE_DIR/agents"

# Target directories (where opencode looks)
OPENCODE_DIR="$HOME/.config/opencode"
COMMANDS_TARGET="$OPENCODE_DIR/commands"
AGENTS_TARGET="$OPENCODE_DIR/agents"

# Check if .claude directories exist
if [[ ! -d "$COMMANDS_SRC" && ! -d "$AGENTS_SRC" ]]; then
    echo "Warning: Neither ~/.claude/commands nor ~/.claude/agents found."
    echo "Skipping opencode link creation."
    exit 0
fi

# Create ~/.config/opencode directory if it doesn't exist
mkdir -p "$OPENCODE_DIR"

# Function to create or update symlink
create_symlink() {
    local src="$1"
    local target="$2"
    local name="$3"
    
    if [[ ! -d "$src" ]]; then
        echo "Source directory not found: $src"
        return
    fi
    
    # If target exists and is a symlink, remove it
    if [[ -L "$target" ]]; then
        echo "Updating existing symlink: $target -> $src"
        rm -f "$target"
    # If target exists and is a directory, backup and remove
    elif [[ -d "$target" ]]; then
        backup="${target}.backup.$(date +%Y%m%d%H%M%S)"
        echo "Backing up existing directory: $target -> $backup"
        mv "$target" "$backup"
    fi
    
    # Create the symlink
    ln -s "$src" "$target"
    echo "Created symlink: $name -> $src"
}

# Create symlinks
create_symlink "$COMMANDS_SRC" "$COMMANDS_TARGET" "commands"
create_symlink "$AGENTS_SRC" "$AGENTS_TARGET" "agents"

echo "opencode configuration links created successfully!"
