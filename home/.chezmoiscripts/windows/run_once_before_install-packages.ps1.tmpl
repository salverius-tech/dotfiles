# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
# Windows package installation script

# Check for Administrator privileges
if (-Not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] 'Administrator')) {
    Write-Host "ERROR: This script requires Administrator privileges." -ForegroundColor Red
    Write-Host "Please run PowerShell as Administrator and try again." -ForegroundColor Yellow
    Write-Host "Right-click PowerShell → 'Run as administrator'" -ForegroundColor Cyan
    exit 1
}

# Enable SSH Agent service (required for SSH keys)
Write-Host "Configuring SSH Agent service..." -ForegroundColor Cyan
$sshAgent = Get-Service -Name ssh-agent -ErrorAction SilentlyContinue
if ($sshAgent) {
    if ($sshAgent.StartType -eq 'Disabled') {
        Set-Service -Name ssh-agent -StartupType Automatic
        Write-Host "  Enabled ssh-agent (set to Automatic)" -ForegroundColor Green
    }
    if ($sshAgent.Status -ne 'Running') {
        Start-Service -Name ssh-agent -ErrorAction SilentlyContinue
        Write-Host "  Started ssh-agent service" -ForegroundColor Green
    }
} else {
    Write-Warning "  ssh-agent service not found. Install OpenSSH Client via Windows Settings → Apps → Optional Features."
}

Write-Host "Installing packages for Windows..." -ForegroundColor Cyan

# Check PowerShell execution policy
$currentPolicy = Get-ExecutionPolicy -Scope CurrentUser
if ($currentPolicy -eq 'Restricted' -or $currentPolicy -eq 'AllSigned') {
    Write-Host "WARNING: PowerShell execution policy is set to '$currentPolicy'" -ForegroundColor Red
    Write-Host "This will prevent your PowerShell profile from loading." -ForegroundColor Yellow
    Write-Host "To fix this, run PowerShell as Administrator and execute:" -ForegroundColor Cyan
    Write-Host "  Set-ExecutionPolicy RemoteSigned -Scope LocalMachine" -ForegroundColor White
    Write-Host ""
    Write-Host "Continuing with package installation anyway..." -ForegroundColor Yellow
}

# Install Starship prompt
if (-not (Get-Command starship -ErrorAction SilentlyContinue)) {
    Write-Host "Installing Starship..." -ForegroundColor Yellow
    winget install --id Starship.Starship -e --accept-source-agreements --accept-package-agreements --silent
} else {
    Write-Host "Starship already installed, skipping..." -ForegroundColor Green
}

# Install Visual Studio Code
if (-not (Get-Command code -ErrorAction SilentlyContinue)) {
    Write-Host "Installing Visual Studio Code..." -ForegroundColor Yellow
    winget install --id Microsoft.VisualStudioCode -e --accept-source-agreements --accept-package-agreements --silent
} else {
    Write-Host "Visual Studio Code already installed, skipping..." -ForegroundColor Green
}

# Install JetBrains Mono Nerd Font
Write-Host "Installing JetBrains Mono Nerd Font..." -ForegroundColor Yellow
winget install --id DEVCOM.JetBrainsMonoNerdFont -e --accept-source-agreements --accept-package-agreements --silent

# Install Bun (JavaScript runtime required for opencode on Windows)
Write-Host "Checking for Bun installation..." -ForegroundColor Cyan
if (-not (Get-Command bun -ErrorAction SilentlyContinue)) {
    Write-Host "Installing Bun..." -ForegroundColor Yellow
    try {
        # Check Windows version (Bun requires Windows 10 1809+ / build 17763)
        $WinVer = [System.Environment]::OSVersion.Version
        $MinBuild = 17763
        if ($WinVer.Major -lt 10 -or ($WinVer.Major -eq 10 -and $WinVer.Build -lt $MinBuild)) {
            Write-Warning "Bun requires Windows 10 version 1809 or newer. Skipping Bun installation."
        } else {
            # Use official Bun install script
            powershell -c "irm bun.sh/install.ps1 | iex"
            # Add Bun to PATH for current session
            $env:PATH = "$env:USERPROFILE\.bun\bin;$env:PATH"
            Write-Host "Bun installed successfully" -ForegroundColor Green
        }
    } catch {
        Write-Warning "Failed to install Bun: $_"
    }
} else {
    Write-Host "Bun already installed, skipping..." -ForegroundColor Green
}

# Install opencode using Bun
Write-Host "Checking for opencode installation..." -ForegroundColor Cyan
if (Get-Command bun -ErrorAction SilentlyContinue) {
    if (-not (Get-Command opencode -ErrorAction SilentlyContinue)) {
        Write-Host "Installing opencode via Bun..." -ForegroundColor Yellow
        try {
            bun add -g opencode-ai
            Write-Host "opencode installed successfully" -ForegroundColor Green
            Write-Host "Run 'opencode' to start the AI assistant" -ForegroundColor Cyan
        } catch {
            Write-Warning "Failed to install opencode via Bun: $_"
        }
    } else {
        Write-Host "opencode already installed, skipping..." -ForegroundColor Green
    }
} else {
    Write-Warning "Bun not available, skipping opencode installation"
}

# Install recommended VS Code extensions
Write-Host "Checking VS Code extensions..." -ForegroundColor Cyan
$extensions = @(
    "usernamehw.errorlens",             # Inline error highlighting
    "christian-kohler.path-intellisense", # Autocomplete filenames
    "esbenp.prettier-vscode",           # Code formatting (JavaScript, TypeScript, HTML, CSS, JSON)
    "vscode-icons-team.vscode-icons",   # File icons
    "eamodio.gitlens",                  # Git supercharged
    "ms-azuretools.vscode-docker",      # Docker integration
    "ms-python.python",                 # Python support
    "ms-vscode.powershell",             # PowerShell support
    "yzhang.markdown-all-in-one",       # Markdown tools
    "redhat.vscode-yaml",               # YAML support
    "ms-vscode-remote.remote-ssh",      # Remote SSH
    "ms-vscode-remote.remote-wsl",      # Remote WSL
    "ms-vscode-remote.remote-containers" # Dev Containers
)

foreach ($ext in $extensions) {
    try {
        $installed = code --list-extensions 2>$null | Select-String $ext
        if (-not $installed) {
            Write-Host "Installing VS Code extension: $ext" -ForegroundColor Yellow
            code --install-extension $ext --force 2>$null
            Write-Host "Installed $ext" -ForegroundColor Green
        } else {
            Write-Host "$ext already installed" -ForegroundColor Green
        }
    } catch {
        Write-Warning "Could not install extension $ext : $_"
    }
}

Write-Host "Package installation complete!" -ForegroundColor Green
Write-Host "" -ForegroundColor White
Write-Host "Post-setup actions required:" -ForegroundColor Cyan
Write-Host "  1. Restart Windows Terminal to load new settings" -ForegroundColor White
Write-Host "  2. Restart VS Code to apply settings" -ForegroundColor White
Write-Host "  3. Restart Docker Desktop for 4GB RAM config" -ForegroundColor White
Write-Host "  4. Run 'wsl --shutdown' and reopen WSL" -ForegroundColor White
